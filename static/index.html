<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtrader MCP Service</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="file"], textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .results {
            margin-top: 30px;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 4px;
            display: none;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .metric-item {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
        }
        .metric-name {
            font-weight: bold;
            color: #555;
        }
        .chart-container {
            margin-top: 20px;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            background-color: #f9f9f9;
        }
        .tab.active {
            background-color: white;
            border-bottom: 2px solid white;
            margin-bottom: -1px;
            font-weight: bold;
        }
        .tab-content {
            display: none;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 0 4px 4px 4px;
        }
        .tab-content.active {
            display: block;
        }
        .data-source-container {
            display: none;
        }
        .benchmark-container {
            margin-top: 15px;
        }
        .loading {
            display: inline-block;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <h1>Backtrader MCP Service</h1>
    <p>Upload your strategy and data files to run a backtest</p>
    
    <div class="tabs">
        <div class="tab active" data-tab="file-upload">File Upload</div>
        <div class="tab" data-tab="akshare-data">AkShare Data</div>
        <div class="tab" data-tab="mcp-interface">MCP Interface</div>
        <div class="tab" data-tab="integrated">Integrated Backtest</div>
    </div>
    
    <form id="backtest-form">
        <div class="tab-content active" id="file-upload-tab">
            <div class="form-group">
                <label for="strategy-file">Strategy File (Python):</label>
                <input type="file" id="strategy-file" name="strategy_file" accept=".py" required>
            </div>
            
            <div class="form-group">
                <label for="data-file">Data File (CSV):</label>
                <input type="file" id="data-file" name="data_file" accept=".csv" required>
            </div>
        </div>
        
        <div class="tab-content" id="akshare-data-tab">
            <div class="form-group">
                <label for="strategy-file-akshare">Strategy File (Python):</label>
                <input type="file" id="strategy-file-akshare" name="strategy_file_akshare" accept=".py" required>
            </div>
            
            <div class="form-group">
                <label for="data-source-type">Data Source Type:</label>
                <select id="data-source-type">
                    <option value="">Select a data source type</option>
                    <option value="akshare_etf">AkShare ETF</option>
                    <option value="akshare_index">AkShare Index</option>
                </select>
            </div>
            
            <div class="form-group data-source-container" id="data-source-container">
                <label for="data-source">Data Symbol:</label>
                <select id="data-source" name="data_source">
                    <option value="">Select a symbol</option>
                </select>
            </div>
        </div>

        <div class="tab-content" id="mcp-interface-tab">
            <h3>MCP接口测试</h3>
            <p>测试AkShare数据接口，支持股票、基金、指数等数据获取</p>
            
            <div class="form-group">
                <label for="mcp-interface">接口名称:</label>
                <select id="mcp-interface">
                    <option value="">选择接口</option>
                    <option value="stock_zh_a_hist">股票历史数据 (stock_zh_a_hist)</option>
                    <option value="fund_em_open_fund_info">基金信息 (fund_em_open_fund_info)</option>
                    <option value="index_zh_a_hist">指数历史数据 (index_zh_a_hist)</option>
                    <option value="stock_zh_a_spot_em">股票实时数据 (stock_zh_a_spot_em)</option>
                    <option value="fund_etf_spot_em">ETF实时数据 (fund_etf_spot_em)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="mcp-params">接口参数 (JSON格式):</label>
                <textarea id="mcp-params" rows="6" placeholder='示例:
{
  "symbol": "000001",
  "period": "daily",
  "start_date": "20240101",
  "end_date": "20241201"
}'></textarea>
            </div>
            
            <div class="form-group">
                <label for="mcp-request-id">请求ID:</label>
                <input type="text" id="mcp-request-id" value="test001" placeholder="请求标识符">
            </div>
            
            <button type="button" onclick="testMCPInterface()">测试接口</button>
            
            <div id="mcp-results" style="margin-top: 20px; display: none;">
                <h4>接口响应:</h4>
                <pre id="mcp-response" style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;"></pre>
            </div>
        </div>
        
        <div class="tab-content" id="integrated-tab">
            <h3>集成回测 - AkShare数据 + 策略</h3>
            <p>使用AkShare数据接口直接进行策略回测，无需手动下载数据</p>
            
            <div class="form-group">
                <label for="strategy-file-integrated">策略文件 (Python):</label>
                <input type="file" id="strategy-file-integrated" name="strategy_file_integrated" accept=".py" required>
            </div>
            
            <div class="form-group">
                <label for="integrated-interface">数据接口:</label>
                <select id="integrated-interface" name="integrated_interface">
                    <option value="">选择接口</option>
                    <option value="stock_zh_a_hist">股票历史数据 (stock_zh_a_hist)</option>
                    <option value="fund_etf_hist_em">ETF历史数据 (fund_etf_hist_em)</option>
                    <option value="index_zh_a_hist">指数历史数据 (index_zh_a_hist)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="integrated-symbol">股票/ETF代码:</label>
                <input type="text" id="integrated-symbol" name="integrated_symbol" placeholder="例如: 000001, 518880">
            </div>
            
            <div class="form-group">
                <label for="integrated-start-date">开始日期:</label>
                <input type="text" id="integrated-start-date" name="integrated_start_date" placeholder="格式: YYYYMMDD, 例如: 20200101">
            </div>
            
            <div class="form-group">
                <label for="integrated-end-date">结束日期:</label>
                <input type="text" id="integrated-end-date" name="integrated_end_date" placeholder="格式: YYYYMMDD, 例如: 20241201">
            </div>
        </div>
        
        <div class="form-group benchmark-container">
            <label for="benchmark-symbol">Benchmark Symbol (optional):</label>
            <select id="benchmark-symbol" name="benchmark_symbol">
                <option value="">None</option>
                <option value="000300">沪深300 (CSI 300)</option>
                <option value="000001">上证指数 (SSE)</option>
                <option value="399001">深证成指 (SZSE)</option>
                <option value="399006">创业板指 (ChiNext)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="params">Strategy Parameters (JSON, optional):</label>
            <textarea id="params" name="params" rows="4" placeholder='{"fast_period": 5, "slow_period": 20}'></textarea>
        </div>
        
        <button type="submit">Run Backtest</button>
    </form>
    
    <div id="error" class="error"></div>
    
    <div id="results" class="results">
        <h2>Backtest Results</h2>
        
        <div class="metrics" id="metrics-container">
            <!-- Metrics will be inserted here -->
        </div>
        
        <div class="chart-container">
            <h3>Performance Chart</h3>
            <img id="chart" src="" alt="Performance Chart" style="max-width: 100%;">
        </div>
    </div>
    
    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                document.getElementById(this.dataset.tab + '-tab').classList.add('active');
            });
        });
        
        // Load data sources
        async function loadDataSources() {
            try {
                const response = await fetch('/api/data-sources');
                if (!response.ok) {
                    throw new Error('Failed to load data sources');
                }
                
                const data = await response.json();
                return data.sources;
            } catch (error) {
                console.error('Error loading data sources:', error);
                return [];
            }
        }
        
        // Populate data source dropdown based on selected type
        document.getElementById('data-source-type').addEventListener('change', async function() {
            const sourceType = this.value;
            const sourceContainer = document.getElementById('data-source-container');
            const sourceSelect = document.getElementById('data-source');
            
            if (!sourceType) {
                sourceContainer.style.display = 'none';
                return;
            }
            
            // Show loading indicator
            this.insertAdjacentHTML('afterend', '<span class="loading">Loading symbols...</span>');
            
            try {
                const sources = await loadDataSources();
                const source = sources.find(s => s.name.toLowerCase().replace(/\s+/g, '_') === sourceType);
                
                // Remove loading indicator
                document.querySelector('.loading').remove();
                
                if (source) {
                    // Populate symbols dropdown
                    sourceSelect.innerHTML = '<option value="">Select a symbol</option>';
                    Object.entries(source.symbols).forEach(([symbol, description]) => {
                        const option = document.createElement('option');
                        option.value = `akshare:${symbol}`;
                        option.textContent = `${symbol} - ${description}`;
                        sourceSelect.appendChild(option);
                    });
                    
                    // Show data source container
                    sourceContainer.style.display = 'block';
                } else {
                    sourceContainer.style.display = 'none';
                }
            } catch (error) {
                console.error('Error:', error);
                document.querySelector('.loading').remove();
            }
        });
        
        // Form submission
        document.getElementById('backtest-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            
            // Get strategy file based on active tab
            let strategyFile;
            let endpoint = '/api/backtest';
            
            if (activeTab === 'file-upload') {
                strategyFile = document.getElementById('strategy-file').files[0];
            } else if (activeTab === 'akshare-data') {
                strategyFile = document.getElementById('strategy-file-akshare').files[0];
            } else if (activeTab === 'integrated') {
                strategyFile = document.getElementById('strategy-file-integrated').files[0];
                endpoint = '/api/backtest-with-mcp';
            }
            
            if (!strategyFile) {
                document.getElementById('error').textContent = 'Please select a strategy file';
                return;
            }
            
            formData.append('strategy_file', strategyFile);
            
            // Get data source based on active tab
            if (activeTab === 'file-upload') {
                const dataFile = document.getElementById('data-file').files[0];
                if (!dataFile) {
                    document.getElementById('error').textContent = 'Please select a data file';
                    return;
                }
                formData.append('data_file', dataFile);
            } else if (activeTab === 'akshare-data') {
                const dataSource = document.getElementById('data-source').value;
                if (!dataSource) {
                    document.getElementById('error').textContent = 'Please select a data source';
                    return;
                }
                formData.append('data_source', dataSource);
            } else if (activeTab === 'integrated') {
                const interface_name = document.getElementById('integrated-interface').value;
                const symbol = document.getElementById('integrated-symbol').value;
                const start_date = document.getElementById('integrated-start-date').value;
                const end_date = document.getElementById('integrated-end-date').value;
                
                if (!interface_name || !symbol) {
                    document.getElementById('error').textContent = '请选择数据接口和输入股票/ETF代码';
                    return;
                }
                
                formData.append('interface', interface_name);
                formData.append('symbol', symbol);
                
                if (start_date) {
                    formData.append('start_date', start_date);
                }
                
                if (end_date) {
                    formData.append('end_date', end_date);
                }
            }
            
            // Add benchmark if selected
            const benchmarkSymbol = document.getElementById('benchmark-symbol').value;
            if (benchmarkSymbol) {
                formData.append('benchmark_symbol', benchmarkSymbol);
            }
            
            // Add parameters if provided
            const params = document.getElementById('params').value;
            if (params) {
                formData.append('params', params);
            }
            
            // Show loading state
            document.getElementById('error').textContent = '';
            document.getElementById('results').style.display = 'none';
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.textContent = 'Running...';
            submitButton.disabled = true;
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Error running backtest');
                }
                
                const result = await response.json();
                
                // Display results
                displayResults(result);
                
                // Reset form state
                submitButton.textContent = 'Run Backtest';
                submitButton.disabled = false;
                
            } catch (error) {
                document.getElementById('error').textContent = error.message;
                submitButton.textContent = 'Run Backtest';
                submitButton.disabled = false;
            }
        });
        
        function displayResults(result) {
            // Show results container
            document.getElementById('results').style.display = 'block';
            
            // Display metrics
            const metricsContainer = document.getElementById('metrics-container');
            metricsContainer.innerHTML = '';
            
            const metrics = result.metrics;
            const metricItems = [
                { name: 'Total Return', value: metrics.total_return.toFixed(2) + '%' },
                { name: 'Annual Return', value: metrics.annual_return.toFixed(2) + '%' },
                { name: 'Sharpe Ratio', value: metrics.sharpe_ratio.toFixed(2) },
                { name: 'Sortino Ratio', value: metrics.sortino_ratio.toFixed(2) },
                { name: 'Max Drawdown', value: metrics.max_drawdown.toFixed(2) + '%' },
                { name: 'Total Trades', value: metrics.total_trades },
                { name: 'Win Rate', value: metrics.win_rate.toFixed(2) + '%' },
                { name: 'Profit Factor', value: metrics.profit_factor.toFixed(2) },
                { name: 'Avg Trade Duration', value: metrics.avg_trade_duration.toFixed(2) + ' bars' }
            ];
            
            // Add benchmark metrics if available
            if (metrics.alpha !== null) {
                metricItems.push({ name: 'Alpha', value: metrics.alpha.toFixed(2) + '%' });
                metricItems.push({ name: 'Beta', value: metrics.beta.toFixed(2) });
                metricItems.push({ name: 'Information Ratio', value: metrics.information_ratio.toFixed(2) });
            }
            
            metricItems.forEach(item => {
                const metricElement = document.createElement('div');
                metricElement.className = 'metric-item';
                metricElement.innerHTML = `
                    <div class="metric-name">${item.name}</div>
                    <div class="metric-value">${item.value}</div>
                `;
                metricsContainer.appendChild(metricElement);
            });
            
            // Display chart
            document.getElementById('chart').src = 'data:image/png;base64,' + result.chart;
        }

        // MCP Interface Testing Function
        async function testMCPInterface() {
            const interface_name = document.getElementById('mcp-interface').value;
            const params_text = document.getElementById('mcp-params').value;
            const request_id = document.getElementById('mcp-request-id').value;
            
            if (!interface_name) {
                alert('请选择接口名称');
                return;
            }
            
            let params = {};
            if (params_text.trim()) {
                try {
                    params = JSON.parse(params_text);
                } catch (e) {
                    alert('参数格式错误，请输入有效的JSON格式');
                    return;
                }
            }
            
            const requestData = {
                interface: interface_name,
                params: params,
                request_id: request_id || 'test001'
            };
            
            try {
                const response = await fetch('/api/mcp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                // Display results
                document.getElementById('mcp-results').style.display = 'block';
                document.getElementById('mcp-response').textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                document.getElementById('mcp-results').style.display = 'block';
                document.getElementById('mcp-response').textContent = 'Error: ' + error.message;
            }
        }

        // Update interface parameters based on selection
        document.getElementById('mcp-interface').addEventListener('change', function() {
            const interface_name = this.value;
            const paramsTextarea = document.getElementById('mcp-params');
            
            // Provide example parameters for different interfaces
            const examples = {
                'stock_zh_a_hist': '{\n  "symbol": "000001",\n  "period": "daily",\n  "start_date": "20240101",\n  "end_date": "20241201"\n}',
                'fund_em_open_fund_info': '{\n  "fund": "000001",\n  "indicator": "单位净值走势"\n}',
                'index_zh_a_hist': '{\n  "symbol": "000001",\n  "period": "daily",\n  "start_date": "20240101",\n  "end_date": "20241201"\n}',
                'stock_zh_a_spot_em': '{}',
                'fund_etf_spot_em': '{}'
            };
            
            if (examples[interface_name]) {
                paramsTextarea.value = examples[interface_name];
            } else {
                paramsTextarea.value = '';
            }
        });
    </script>
</body>
</html>